%program finite_difference_calculation_2D_with_screen_v1_scaled.m
%first edition 29112017
%addition of absorbing boundary layers (PML) Lei 19-01-2018
%screen 14012018
clear all
%close all

ax=100;
ay=100;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%USER DEFINITIONS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%
c0=340;
rho0=1.3;
factor=4;
xmax=10;
ymax=10;
nx=ax*factor;
ny=ay*factor;

sources=[6.5,4];

source_width_x=0.1;
source_width_y=0.1;
ywallbottom=0;

%ywalltop=1.5;
ywalltop=0.01;

xwall=5;
imovie=2;
ipauze=400;
nt=800;

%yymin=-0.05;
%yymax=0.08;

yymin=-0.15;
yymax=0.15;

schaal_v=[0 1.5];
schaal_p=[-0.3 0.3];


aantal=5;
radius = 4;
xCenter = 5;
yCenter = 5;
angles = linspace(0, 2*pi, aantal+1);
mics=zeros(aantal,2);
for i=1:aantal
    mics(i,1)=round(radius * cos(angles(i)) + xCenter);
    mics(i,2)=round(radius * sin(angles(i)) + yCenter);
end    


%mics=[ 9.0,6.5,
 %      .5,8.5,
  %     4.5,1.5,
   %    7.5,2.5,
    %   2.5,5.0,
     %  1.0,1.0,
      % 6.0,4.0];
      
%mics=[1,5,
 %     3,8,
  %    3,2,
   %   7,8,
    %  7,2,
     % 9,5]
      
      
      
%mics=[2,1,
 %     2,2,
  %    2,8,
   %   3,2,
    %  9,5];      
      
      
   
mic=zeros(nt,size(mics,1));

%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%



vx=zeros(nx,ny);
vy=zeros(nx,ny);

x=linspace(0,xmax,nx)';
y=linspace(0,ymax,ny)';
xmat=x*ones(1,ny);
ymat=ones(nx,1)*y';

p=zeros(nx,ny);
%%%Ingang t=0%%%

%for i=1:size(sources,1),
 %   p=p+exp(-((xmat-sources(i,1))/source_width_x).^2-((ymat-sources(i,2))/source_width_y).^2);
%end

%p=exp(-((xmat-xsource)/source_width_x).^2-((ymat-ysource)/source_width_x).^2);


dx=x(2)-x(1);
dy=y(2)-y(1);

c=ones(nx,ny)*c0;

rho=ones(nx,ny)*rho0;

%rho(:,150:200)=0.1;

rhox=0.5*p./(c.^2);
rhoy=0.5*p./(c.^2);


dt=0.5*sqrt(dx^2+dy^2)/max(max(c));


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% PML
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

pml_x=ones(nx,1);
pml_y=ones(1,ny);

pml_size=20;  %%in number of pixels
decay_factor=4;

pml_index=1:pml_size;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
pml_x_up=decay_factor*(max(c(:))/dx)*((pml_index-pml_size-1)./(0-pml_size)).^4;
pml_x_down=decay_factor*(max(c(:))/dx)*(pml_index./pml_size).^4;

pml_x_up=exp(-pml_x_up*dt/2);
pml_x_down=exp(-pml_x_down*dt/2);


pml_y_left=decay_factor*(max(c(:))/dy)*((pml_index-pml_size-1)./(0-pml_size)).^4;
pml_y_right=decay_factor*(max(c(:))/dy)*(pml_index./pml_size).^4;

pml_y_left=exp(-pml_y_left*dt/2);
pml_y_right=exp(-pml_y_right*dt/2);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
pml_x(1:pml_size,1)=pml_x_up;
pml_x(end-pml_size+1:end,1)=pml_x_down;
pml_y(1,1:pml_size)=pml_y_left;
pml_y(1,end-pml_size+1:end)=pml_y_right;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
decay_matrix_x=pml_x*ones(1,ny);
decay_matrix_y=ones(nx,1)*pml_y;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%staggered grid



%T=(1:nt)';
image_counter=0;
AA=clock;AAA=['y',int2str(AA(1)),'m',int2str(AA(2)),'d',int2str(AA(3)),'_',int2str(AA(4)),'h',int2str(AA(5))];

%noice=randn(nt,1);

%Noice used for simulations in our paper: 
noice=[0.264779593231891;1.11543096361093;0.874243540329865;-0.804637737248557;-1.23935584629923;-1.27182034125703;1.28695499074120;-0.0609125988831987;0.404772847879767;-0.536573834678158;0.782305792133754;0.432561651725464;0.278856392914729;0.461512527987891;-0.641505559883439;1.27199961404842;-0.245431658828442;1.72058616920714;0.682550391728879;-0.0934697404844741;0.765459066841665;-0.273039978570827;-0.424580572072847;1.35189000624222;-0.440156397677797;0.699199955714195;1.18952183092839;-1.14696881297398;-0.512488761984384;1.65918333168844;0.0254636868550446;-0.175127712992901;-0.347313366992835;0.516382847506849;-1.21143676320226;-0.701345761211894;2.73002992185806;1.29295747448394;-0.193899705598321;-0.602818719905659;-0.282043756426735;0.231697991863167;0.196037136917433;-0.536887336441489;-0.433378432538177;-1.22695135206398;-0.126424653515384;1.30751650400795;-0.709270091073951;-0.237406767327209;-0.833052568565256;0.712669051942891;0.143349088468490;1.06242940451526;-1.32577408999530;0.988182560565257;-0.445500682954858;0.815152369745413;-0.288892304606097;1.11601538124311;-0.129670418388054;0.608418526297342;-0.635967453037615;1.08502280831718;0.276962554783376;0.664184447384310;-1.22173351357639;-0.250136915215207;0.139110312462216;0.0918169574196932;2.14017482719995;0.191748023560121;0.00377429024275797;-1.00037360483729;-0.356864378206038;1.25032900660763;0.0569847151936186;0.272563680315700;0.368880954676641;0.477337397820001;2.19343840600900;0.990331487125840;0.352396558025398;0.373127619767853;0.340163402587385;0.626371815109892;0.895943357124599;0.430390790844444;-0.788463457504418;1.82166542603344;0.895411124620505;0.234499175719910;-1.73836696415693;0.497884955543512;0.340918633208765;0.509831597997171;-1.66273448859428;-0.437947121522206;0.626971475110808;0.691260117275477;1.58972840256927;-0.110433254889384;-0.678455982514408;-0.0163954231303144;-1.38783468751690;0.586638756019354;-0.729097884862225;0.556291923012774;-0.763973072094419;-0.288408856640698;0.674334735398495;0.259387754846201;-0.0145130757868906;0.282150075175652;-1.24870749153058;-1.15669663632031;-0.402434500104590;0.0508449023931117;-0.572176051867679;-1.32750512755173;0.838604483607109;-1.31449554167910;-0.854899760689168;-0.480818834492751;0.866959574331283;-1.66062476629663;-1.48531588555236;-1.23247003533108;-0.411755170589070;0.861543156989010;-1.98123608372283;0.835905837398566;-0.690160421549108;0.342001626692772;-1.77120196265515;-0.817838239369046;0.00453938881961874;-0.544852363134893;1.47635633428752;-2.65389365968281;0.407928464078369;-0.502301915383839;0.569552057349539;0.744880881877821;-1.34972111093064;-0.447607169624289;-0.389275562291569;0.545307461761618;-1.00302529899381;1.78670016487597;0.0152996007408076;0.294787472073324;0.0968142254378899;-0.232623321325639;-0.412745874221707;-0.727058513481886;-0.670223249993902;0.172866977449641;1.10072308290051;-1.92855395870034;-0.128668813870976;-0.236378419965408;-1.29437105989652;-1.22955131538752;-0.0816291297692240;-0.290835331316368;-0.382930353354437;0.459603400202266;0.276178376386877;-0.216317013847122;-0.650078481474492;-0.837501710442201;-0.158398601093440;-0.394425711395701;-0.418136973167338;-0.291768753336113;-0.949017924404409;-0.808111200049336;-0.891415536384287;0.0693496350946214;1.15254130114178;1.67073824701525;0.572143932020537;-1.83377869159109;-1.22703778044482;0.326325857972189;-0.669692475167958;0.693007025095863;0.239007427706014;0.816118902861464;0.199742133265873;1.36413232640152;-1.03996911629021;1.26358458364550;-0.340599024900692;1.43012626851944;-1.30090836686904;0.686528552372670;-0.912088146141538;-1.21518544673563;-0.594288786452107;-0.656606004742685;-0.378824887668115;0.725186188808085;-0.185954358083829;0.811409441640541;1.08397342424295;-0.537274520420282;0.967872960985654;-1.33899442307917;-1.21853449705290;-2.54236747494416;-0.242089849612912;1.31026767887994;0.675572248815756;-0.0280079033621790;-0.418898210903040;0.738156970760806;-0.608519930934355;-0.577194330731480;1.69562474678581;-1.05874168184408;1.20455427675171;-0.575686166376375;-1.59348327977703;1.39793730301701;1.38833969841553;-2.78455323447464;1.56009469178540;-1.25942926834984;-0.785068814170355;-0.812107317258500;0.409375762105560;-0.453473085305396;-1.09787487431264;0.231697234935473;0.241489083115446;-0.897088081996968;0.179320459697200;1.03811939176275;1.47925560816800;-1.10752931395013;0.606582772915176;-0.0882088437577041;-0.328414683824131;0.762917344346561;0.0755460339147649;-0.728140002087824;-0.901472966650426;-1.13980402533964;-0.859491743474934;-0.421873751629473;1.80357002717587;-0.144801357217444;-0.148535966377768;0.208349573531474;-1.50389834682891;-0.763652459719487;-0.362269341338531;2.06317839166365;-1.52136112875127;1.04250653276149;0.00480090596631259;-0.868267715516145;-0.745536461437451;0.366838846556294;-2.06120290203788;-1.96871119191928;-1.11635417554951;-2.39723069458485;-2.33886057980078;0.629779002472691;0.735223796061369;0.171570541785814;-0.686924175643349;-1.14963436607084;-1.62418334389424;-0.637427464852642;0.245982035692339;-0.582978000382100;0.999264484954677;-0.0879701594749326;-0.463491795736746;-0.459556840180914;0.298315761073269;1.56540514885200;0.527424502547016;0.788833636376933;-2.14970221011619;1.55708565656416;0.397635790171863;0.767336260824983;-1.75801529677152;1.13949019697077;-1.34705331750986;1.53074201245572;-0.598191750469654;0.645339892660919;-1.11928893303128;0.221486670246346;-0.868884673201852;-1.31337023693905;1.25146161201989;1.01834578243005;-0.418301579426130;-0.788007447073355;-0.419243431703464;-0.203123200765283;-0.287397465706249;-2.09766664347601;-0.761377014417220;0.184253182013690;-0.955972448923369;-1.54110657134585;-1.03772772357682;0.168730413011338;-0.409631146866548;-1.08318806264242;1.64616124557711;1.34878013403318;0.305633327979711;-0.451921432654426;0.295828921378655;0.727139712977962;-0.399387682228664;-1.20093270529360;0.137493357975863;1.73617308785781;-0.496217669173705;-0.734786117562906;-0.854980023921645;1.98875524802758;-0.0256169127134205;-1.34647957743327;-0.319414243144540;1.40155606981428;1.03842103972888;-0.0227629333803109;0.929259719417251;0.370590858006700;-0.930201033894416;0.895708865913376;-1.43137682285932;1.30955973796761;0.608607495464683;0.577868448502271;-0.889056466574848;-0.230645070761376;0.451611730339573;2.33025784037423;-0.427094478758392;-0.967051743027144;1.21201500085551;-1.19433223402361;-1.84311099780482;0.816737296180678;-0.128320790074557;-0.124640728017446;0.694029824192130;-0.942481524090483;-2.72825547515533;1.30338190441265;0.266382367950320;0.689776063745086;1.15504030621104;0.0977421365547141;-0.232734912862326;-1.41768699777321;-0.511066324563624;-1.01469947555171;-1.82497180585007;0.374577244017829;1.84002461014084;1.14663327238680;-1.95006632914811;1.68152154718269;-0.951835611097279;0.638070629197398;-0.781824014174686;0.949377991325884;0.0698403798238351;-0.0236116891871254;-0.124670094912015;-0.410708263136767;-0.601697891729598;-0.271933270048836;0.503997627721113;-1.46975407372734;-0.531273491117828;0.385689971127462;0.00133378598354107;1.77269845133585;-0.593118598339689;-0.607005712692380;1.72877034692959;1.13939897878500;0.745908207214728;-1.62686503560427;-0.317438209861390;0.486836009903867;0.892565493582666;-0.384698230006906;0.267671444285539;0.508586868826997;0.680813694330053;0.209798597988349;-0.0412296824359131;0.352737587345269;0.966227027787511;-0.144363786742976;0.291772755682626;0.978121797552186;-1.01675630337152;-0.201226133219818;0.00988252372764618;-0.411986099175059;-0.159775942289046;0.248500131901106;0.481816194176477;-0.444990302426406;-1.38430667636135;0.241569801997634;0.160410906235784;-0.245516883149762;1.53546746450104;-0.0217779118627351;-0.0546692438172136;1.83858825306673;-0.575879929316888;-0.451760978952827;0.997603919632893;0.701472845680668;0.812274977016145;0.275803974109194;2.45030829107223;-0.675521158443142;0.909895118852614;-0.295655417094930;-0.953049150661464;-0.720772182994756;2.24571362470526;-0.372166315970126;0.877686162280865;-0.804304084972543;0.559692553226787;0.309500559294184;0.399241696729135;0.579234239657434;-0.894368142307868;-1.09530723172929;0.430044024472156;0.0442609619916141;0.317849782055740;1.39682520394997;-0.400869003266554;-0.225702801156129;1.04893066369436;-0.586235115826979;0.422208670021859;0.529774257741756;-1.25052970545992;0.293833658745899;1.71183976830610;-1.62026128281518;-0.712623050842393;-1.19951062193671;-0.292951058962119;-1.35783690652829;-0.0926570733477587;0.323625018062644;-0.188802963096817;0.0533797005830734;-1.17293192603054;0.407690934589854;-0.236336934953454;1.38500854225125;0.374587982628613;-0.844585471817828;0.978395698808366;1.20522514785677;0.257829267372256;0.111413387684708;-0.102470082503084;-1.97403796354341;-0.145435133112888;0.477933069565833;-0.404727389334403;-0.719334152999188;-1.23249635033860;-1.26339695936631;-1.10190548443565;-0.783194739464908;0.324547949656813;2.09262868332121;1.36618299423223;1.43787298011804;1.20997596742701;0.802276887615093;1.21100357670514;-0.416372510529614;-0.243174542716975;0.915821774845116;-0.400636805914121;0.701388064089143;0.821298539640869;-0.135246045214806;0.791820029448771;-0.979731973568817;-0.696022274151319;-1.75976346557906;0.229107532094459;-0.371315121544299;0.602914523772711;-0.370153467957429;-0.274733324432930;0.770540849426696;1.34460687368264;0.860193955492307;-0.613361402978629;0.453946304639161;-0.374690756793635;-0.458442254097615;-0.546321886527224;-0.251236637968374;1.30890807333313;-0.370048569678407;-0.370003502480250;0.804775543567360;0.911115750460841;-0.194973743904851;-0.160326694070093;1.14843184356974;0.534717841869620;-0.168825589584595;-0.346940306595084;1.31096401363325;-0.250304460913576;-2.51982286739453;0.636076801251853;-0.740937903668070;-1.21412033039206;-0.885142362314048;-1.25690736581164;0.839081088455261;-0.300954894127660;-2.54339605901547;1.94349237415369;-0.344152009252788;-0.462638662478180;0.522508078254959;0.678288708811124;0.540476961895219;-1.47500553142438;0.795909779759905;-0.855831012874969;0.647518308773654;1.17272878816089;1.58595770954090;0.842626370719319;1.23839767786223;0.125572655988348;1.44607053750398;-1.14431534756863;-1.04991967138069;0.577289190229149;-1.91281373793266;0.449230800337944;1.49428676894651;-0.500388331084773;0.214954667896043;-0.281185500407135;-0.459582182619459;0.610367831183479;0.601935614990446;-0.479996319133531;-0.197008303882475;-0.937739417252792;-0.398068114037178;-0.00812372208479120;0.667760518780113;-1.91366252417067;1.99509309684638;1.66251043142831;0.911529781666466;-0.427637568999589;0.730039011535366;0.944975603420664;1.31833275298027;-0.350775676181833;-0.170292800727322;2.00791153492932;0.500676141921736;-1.66376421656144;0.674598600710225;0.571691952312802;0.779199564621914;0.00232396474759265;0.780949198209098;0.107634165765700;1.10982077658978;0.317983357599215;0.248542709390287;0.103826117375576;-0.776931122898988;2.31896853163759;0.329260517858062;0.316876868869686;-0.335650305791175;-0.0119836054855438;0.603579284536455;0.464698240243723;-0.676250603844081;0.0243924346425806;-1.58311722958675;-1.06654733181388;-0.315043380117074;0.311591564272493;0.880537913123759;2.07333186798512;-0.664456685516354;-2.50283050801356;1.51006194409476;0.853989026338227;1.09490348967482;0.869109980701839;1.12415154934349;-0.418106551891030;-0.437966898702033;-0.133725689816140;-0.926228459868990;-0.157148485328562;1.11626679883533;-0.0705393603522355;0.648769910684704;-0.0672063274491157;-1.08185533075624;0.972589421293613;-0.480003640127234;-1.07497718763562;-1.05209532513018;0.520446918515633;-1.05954284844045;1.14795617435270;-0.0132136991736211;-0.0962466678606468;0.0479397087199183;0.855801353229525;-0.941682902254046;-0.0159858332155758;1.34544525230014;0.384303024881335;0.0596489525855381;0.148372913357009;-1.10927622568760;-0.131587597639786;0.667548130439387;1.50401944150631;-0.438292655749440;-0.706446561404341;-0.674967858483579;-0.000486703625425290;1.05993207288306;0.360142416913815;0.639107107646451;-1.24057230250310;-0.204660693236844;1.08228816449817;-0.555040755308864;0.147711150522283;-1.00504162538116;-1.28706006903271;0.0111154210130447;-0.254516530874521;1.68426311245494;0.451608477918045;-0.243364512176073;-0.570698829473625;0.195292637147047;0.103947487841242;1.28295954670868;1.47949911940875;0.339532216839163;1.10148958978656;-0.392779763190331;0.818261205765197;-0.186686834245903;-1.40609964075475;-0.591146927419614;0.851820377367263;0.854053750922102;0.432169276873427;-0.965500255793125;0.782513338257683;-0.401335714352463;0.183158754710770;-0.821834935638884;0.402382104710271;0.712079733201008;0.278682042765954;0.311640670307683;1.49805131604750;-0.0536669488173875;-1.06429992120726;0.443983254996382;1.55490151678212;1.25782554194993;2.00506129060804;-0.411409293790764;-0.913057072266058;0.407452427718637;0.631678175734396;-1.49110177233992;0.366294273350293;0.659496118400465;0.567615273484490;0.312311973564728;-0.183984913557750;0.885822295586219;-0.455666489639416;0.469052061452393;-0.201092535455628;-0.215025285455254;-0.386171727915409;-0.906444747979033;0.915212701372467;-0.804327910587224;-0.606089408663273;-1.46826029845518;-0.753356960990851;-0.510336844125378;0.404040009228224;-0.379988614507938;1.55092787003075;0.618377921066624;-1.38152857257603;1.23920488356722;-1.28005226326475;0.374119436321818;0.369796860039003;0.931893908185447;-0.430390452040963;-1.02976718142607;-0.565954726744546;-0.0916458803184042;-0.691554501265732;-0.179291839000553;-2.20039550126726;0.0784077050401697;-0.890849791146887;0.0578082057413337;-1.20791071386070;-0.281860513735519;0.480672866155056;0.769261557125022;-1.25629230709563;-0.718877301904091;0.415550241237780;-0.420641015484625;-0.120108098210970;1.33607328371930;-0.475138839163499;-0.382538490841730;1.17081357648564;-1.18956392607722;-1.29269863652019;0.0392436977187690;1.44846634358396;-1.52811836302223;-0.162754248883041;1.02070069601454;2.06339155436237;-0.606619746021550;-0.169542663788701;1.10103793939791;-0.214615239628886;0.305456396832613;-0.630756099191295;-0.383540057264178;-0.232015012910025;0.0750264981707948;-0.266575337409568;0.476466110243291;-0.0714838961287372;-0.186381973707658;-0.494087118555914;1.64333080399686;-1.65996797846463;-0.0415595929865744;0.664985133908006;0.244703025609444;-1.18299095058014;-0.242537621083152;-0.980796897446665;1.77786381016665;1.76278614612670;-0.102854031621759;0.349756399651022;-0.588341406226345;0.483810483756169;-0.652088476274567;1.37389000842165;-0.299182548279907;1.72949499480706;1.79576711589174;0.689612363824546;0.0659102663512570;0.532936658960686;-0.527258499380131;-1.84861373495908;-0.0331591720266050;-0.529450813306881;1.27227746302425;0.0484720007714130;0.975625965850963;0.384136839492277;0.0590644296156133;-2.86843684810980;-1.57541255856745;0.365128797165888;1.42150062987314;0.543208789481497;0.778550209225489;-0.665841283724856;0.110340090889350;0.0428088749711709;0.387344223277267;0.00652855948218623;-0.467384026464686;-2.33940764839619;-2.92625631928848;-0.0143191166247569;-1.23266610481183;1.61417027901469;-0.598537409727662;-0.188754865395560;-0.904740044542229;0.538207745171116;-0.246525815527208;-0.552638477865984;0.795034284109323;1.50594904856945;-0.259290714580342;-0.453290842389310;-0.593782081535967;1.65787692746753;-1.05969164865287;0.312696595027918;-0.756174491752958;-0.444288632727541;1.51680202073490;-2.21076628384575;1.23565686772027;-0.149112366949529;-1.58236300436783;0.736286152851900;1.83168285153039;0.114624189288118;-0.0523777728183792;-0.826020796576292;-0.474506373329836;0.162304509075647;1.50377296224055;-0.274214763161118;1.06228014159644;1.24323480001990;0.885034770188749;-0.0347809164638512;1.22202035613371;-2.04755746928280;-0.412498573425503;-0.731565023451951;0.257905582198797;-0.244912752621188;-0.808594079726651;2.65126401905300;0.636212614022676;-0.683941615489475;1.23191587865790;0.376990427197889;-0.180463646503842;-0.979571220748010;-1.08180656814877;-1.29213171892552;0.712728467137352;-0.910440998412372;-0.321682233155964;0.939711489339606;0.849839805792000;-0.199171911618057;0.384352249683558;2.14439584050046;0.389149468091661;1.13087181611222;-1.43512082757038;0.445532190092124;0.980828865089464;-1.01188587294146;-1.41523133203689;-1.60714775073888;-1.09238458059558;1.44543625282479;1.34452034231726;-0.132477219861566;-1.29160274499548;-0.547531401830071;-1.72853717504117;-1.61691348239220;0.845158510452454;-0.150808008410068;0.0667702821512459;-0.918250332429001;0.618177774170034;0.690791596943030;-0.282925289791655;-0.169654029844515;-0.302269752583392;0.0569015422987178;-0.980851002254724;-0.220338828042033;-2.63193108279580;1.10289161292838;-0.401071960920723;0.880277658294676;-0.690524107566574;-1.54271964039796;0.656476891394349;1.31688357533358;-0.875731854977939;-0.122915855540711;-1.02712857136281;-2.53522567663707;-0.723157726797704;2.42434912296780;-0.136660377722665;-0.666132146599630;0.542856849339353;-0.220984719886883;0.643656084291495;0.921344906447092;0.815004553735569;1.44647829779245;1.06338518116362;-1.36855998994580;0.00286921057221498;-0.418567602173092;1.35004015096470;0.244584720952568;0.647066330961742;-1.68913988409750;0.348280082197165;-0.262310849448523;-0.262969668952354;-1.23682954171640;0.624751826214842;2.51410020270461;1.38217419710499;0.317134184193317;-0.346942508511331;-1.02544099148358;-1.06016367113451;0.0407224000872332;-0.0376220966812924;-1.68754686476036;-0.159778248694357;-1.57950364225661;1.00155330436570;-0.129786284067729;1.09211502042535;0.155906936160340;0.960327113121529;0.378155285101082;-0.0748306930147713;0.261029373109031;1.86796964374236;-2.95131862925999;-1.37808540058566;-0.560794258068445;0.667375408315774;0.883188363423002;-2.20068909585942;0.819830826318425;-0.932144367128709;0.410879982827518;-0.187858111745275;-0.834539743914587;-0.175766808321528;1.12320538920324;-0.856888949654920;1.01496692706546;0.218195739746058;0.196221180773206;0.320872799314031;-0.527477026944108;-0.0495381740825983;-0.225318063482950;-0.785796585895778;-1.08953176768977;0.332994102407310;0.536700312359887;-0.685725224983195];


for ii=1:nt
 voldx=vx;
 voldy=vy;
 
 
 p0=zeros(nx,ny);
 %%%Tijdsafhankelijke ingang%%%
 %if mod(ii,10)==1
 
 for i=1:size(sources,1),
     p0=p0+noice(ii)*exp(-((xmat-sources(i,2))/source_width_x).^2-((ymat-sources(i,1))/source_width_y).^2);
 end
 
 %end
 
 %pold=p+p0;
 %pold=p;
 
 rhoxold=rhox+0.5*p0./(c.^2);
 rhoyold=rhoy+0.5*p0./(c.^2);
 
 %rhoxold=rhox;
 %rhoyold=rhoy;


 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 vx=decay_matrix_x.*(decay_matrix_x.*voldx-1./rho.*(circshift(p,[1,0])-circshift(p,[0,0]))/(dx)*dt);
 vy=decay_matrix_y.*(decay_matrix_y.*voldy-1./rho.*(circshift(p,[0 1])-circshift(p,[0 0]))/(dy)*dt);

 vx(1,:)=0;
 vx(end,:)=0;
 vy(:,1)=0;
 vy(:,end)=0;
 %IYbottom=find(y>=ywallbottom);
 %IYtop=find(y>=ywalltop);
 %IXW=find(x>=xwall);
 %vy(IYbottom(1):IYtop(1),IXW(1))=0;
 
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 rhox=decay_matrix_x.*(decay_matrix_x.*rhoxold-rho.*(circshift(vx,[0,0])-circshift(vx,[-1,0]))/(dx)*dt);
 rhoy=decay_matrix_y.*(decay_matrix_y.*rhoyold-rho.*(circshift(vy,[0,0])-circshift(vy,[0,-1]))/(dy)*dt);
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 
 %%%%%%%%
 p=c.^2.*(rhox+rhoy);
 %%%%%%%%
 
 
 for i=1:size(mics,1),
     mic(ii,i)=p((nx/xmax)*mics(i,2),(ny/ymax)*mics(i,1));
 end
 
 tijd=ii*dt;
  
 if mod(ii,ipauze)==1 || ii == nt
   

   figure(4);
   imagesc(p,schaal_p);
   title({['Time (s): ',num2str(tijd)]},'FontSize',40);
   xlabel('x (m)','FontSize',30)
   ylabel('y (m)','FontSize',30)
   
   zoom on
   xlim([0 nx]);
   ylim([0 ny]);
   set(gca,'Ydir','normal');
   hold on
   %h3=plot([IXW(1),IXW(1)],[IYbottom(1),IYtop(1)],'r');
   %set(h3,'LineWidth',3);
   %hold on
   plot((nx/xmax)*sources(:,1),(ny/ymax)*sources(:,2),'ko','MarkerSize', 20)
   hold on
   plot((nx/xmax)*mics(:,1),(ny/ymax)*mics(:,2),'rx','MarkerSize', 20)
   hold off
   axis equal
   axis on
   %set(cga,'XTickLabel',{0,1,2,3,4,5,6,7,8,9,10});
   xticks([linspace(0,nx,11)])
   xticklabels({'0','1','2','3','4','5','6','7','8','9','10'})
   yticks([linspace(0,nx,11)])
   yticklabels({'0','1','2','3','4','5','6','7','8','9','10'})
   ax = gca;
   ax.FontSize = 30; 
   a = colorbar;
   ylabel(a,"p' (Pa)",'FontSize',30,'Rotation',270);
   a.Label.Position(1) = 6;
   %pause(0.3);
   %pause
   
   
   if imovie==2,
     hh=figure(4);
     %set(hh,'position',[100 50 1400 700]);
     image_counter=image_counter+1;
     fprintf('storing image %i\n',image_counter);
     G=getframe(hh);
     %FF(image_counter)=G;
     [imind,cm] = rgb2ind(frame2im(G),256);
     if image_counter==1, 
       imwrite(imind,cm,['simulation-diffraction-screen_',AAA,'.gif'],'gif', 'Loopcount',inf); 
       else 
       imwrite(imind,cm,['simulation-diffraction-screen_',AAA,'.gif'],'gif','WriteMode','append'); 
       end;%end if image_counter==1
     %pause(0.5);
     end;%end if imovie==1,
   

   
  end;%end if mod
 end;%end for ii

 
 
 
 
 
 
 
 
 
 %program finite_difference_calculation_2D_with_screen_v1_scaled.m
%first edition 29112017
%addition of absorbing boundary layers (PML) Lei 19-01-2018
%screen 14012018
%clear all
%close all

ax=100;
ay=100;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%USER DEFINITIONS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%
c0=340;
rho0=1.3;
factor=4;
xmax=10;
ymax=10;
nx=ax*factor;
ny=ay*factor;
xsource=1;
ysource=4.5;
source_width_x=0.1;
source_width_y=0.1;
ywallbottom=0;

%ywalltop=1.5;
ywalltop=0.01;

xwall=5;
imovie=2;
ipauze=400;
nt=800;

%yymin=-0.05;
%yymax=0.08;

yymin=-0.15;
yymax=0.15;

schaal_v=[0 1.5];
schaal_p=[-0.3 0.3];

%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%



vx=zeros(nx,ny);
vy=zeros(nx,ny);

x=linspace(0,xmax,nx)';
y=linspace(0,ymax,ny)';
xmat=x*ones(1,ny);
ymat=ones(nx,1)*y';

p=zeros(nx,ny);
%p=exp(-((xmat-xsource)/source_width_x).^2-((ymat-ysource)/source_width_x).^2);


dx=x(2)-x(1);
dy=y(2)-y(1);

c=ones(nx,ny)*c0;

rho=ones(nx,ny)*rho0;

%rho(:,150:200)=0.1;

rhox=0.5*p./(c.^2);
rhoy=0.5*p./(c.^2);


dt=0.5*sqrt(dx^2+dy^2)/max(max(c));


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% PML
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

pml_x=ones(nx,1);
pml_y=ones(1,ny);

pml_size=20;  %%in number of pixels
decay_factor=4;

pml_index=1:pml_size;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
pml_x_up=decay_factor*(max(c(:))/dx)*((pml_index-pml_size-1)./(0-pml_size)).^4;
pml_x_down=decay_factor*(max(c(:))/dx)*(pml_index./pml_size).^4;

pml_x_up=exp(-pml_x_up*dt/2);
pml_x_down=exp(-pml_x_down*dt/2);


pml_y_left=decay_factor*(max(c(:))/dy)*((pml_index-pml_size-1)./(0-pml_size)).^4;
pml_y_right=decay_factor*(max(c(:))/dy)*(pml_index./pml_size).^4;

pml_y_left=exp(-pml_y_left*dt/2);
pml_y_right=exp(-pml_y_right*dt/2);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
pml_x(1:pml_size,1)=pml_x_up;
pml_x(end-pml_size+1:end,1)=pml_x_down;
pml_y(1,1:pml_size)=pml_y_left;
pml_y(1,end-pml_size+1:end)=pml_y_right;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
decay_matrix_x=pml_x*ones(1,ny);
decay_matrix_y=ones(nx,1)*pml_y;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%staggered grid



T=(1:nt)';
image_counter=0;
AA=clock;AAA=['y',int2str(AA(1)),'m',int2str(AA(2)),'d',int2str(AA(3)),'_',int2str(AA(4)),'h',int2str(AA(5))];

image_counter1=0;
AA1=clock;AAA1=['y',int2str(AA(1)),'m',int2str(AA(2)),'d',int2str(AA(3)),'_',int2str(AA(4)),'h',int2str(AA(5))];


sum2=zeros(nx,ny);

for ii=1:nt
 voldx=vx;
 voldy=vy;
 
 
 p0=zeros(nx,ny);
    
    %for i=1:size(mics,1),
     %   p0(round(mics(i,1)*nx/xmax),round(mics(i,2)*ny/ymax))=mic(nt-ii+1,i);
    %end
    
    for i=1:size(mics,1),
        p0=p0+mic(nt-ii+1,i)*exp(-((xmat-mics(i,2))/source_width_x).^2-((ymat-mics(i,1))/source_width_y).^2);
    end
    rhoxold=rhox+0.5*p0./(c.^2);
    rhoyold=rhoy+0.5*p0./(c.^2);
    %pold=p+p0;
 %pold=p;
  
 %rhoxold=0.5*pold./(c.^2);
 %rhoyold=0.5*pold./(c.^2);

 
 %rhoxold=rhox;
 %rhoyold=rhoy;


 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 vx=decay_matrix_x.*(decay_matrix_x.*voldx-1./rho.*(circshift(p,[1,0])-circshift(p,[0,0]))/(dx)*dt);
 vy=decay_matrix_y.*(decay_matrix_y.*voldy-1./rho.*(circshift(p,[0 1])-circshift(p,[0 0]))/(dy)*dt);

 vx(1,:)=0;
 vx(end,:)=0;
 vy(:,1)=0;
 vy(:,end)=0;
 IYbottom=find(y>=ywallbottom);
 IYtop=find(y>=ywalltop);
 IXW=find(x>=xwall);
 vy(IYbottom(1):IYtop(1),IXW(1))=0;
 
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 rhox=decay_matrix_x.*(decay_matrix_x.*rhoxold-rho.*(circshift(vx,[0,0])-circshift(vx,[-1,0]))/(dx)*dt);
 rhoy=decay_matrix_y.*(decay_matrix_y.*rhoyold-rho.*(circshift(vy,[0,0])-circshift(vy,[0,-1]))/(dy)*dt);
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 
 %%%%%%%%
 p=c.^2.*(rhox+rhoy);
 %%%%%%%%
 
 sum2 = sum2 + p.*p;
 
 tijd=ii*dt;
 
 if mod(ii,ipauze)==1 || ii == nt
   

   maximum = max(max(p));
 [x,y]=find(p==maximum);
   
  figure(3);
   imagesc(p,schaal_p);
   title({['Time (s): ',num2str(tijd)]},'FontSize',40);
   xlabel('x (m)','FontSize',30)
   ylabel('y (m)','FontSize',30)
   
   zoom on
   xlim([0 nx]);
   ylim([0 ny]);
   set(gca,'Ydir','normal');
   hold on
   %h3=plot([IXW(1),IXW(1)],[IYbottom(1),IYtop(1)],'r');
   %set(h3,'LineWidth',3);
   %hold on
   plot((nx/xmax)*sources(:,1),(ny/ymax)*sources(:,2),'ko','MarkerSize', 20)
   hold on
   plot((nx/xmax)*mics(:,1),(ny/ymax)*mics(:,2),'rx','MarkerSize', 20)
   %if ii == nt
    hold on
    plot(y,x,'kx','MarkerSize', 30)
   %end
   hold off
   axis equal
   axis on
   %set(cga,'XTickLabel',{0,1,2,3,4,5,6,7,8,9,10});
   xticks([linspace(0,nx,11)])
   xticklabels({'0','1','2','3','4','5','6','7','8','9','10'})
   yticks([linspace(0,nx,11)])
   yticklabels({'0','1','2','3','4','5','6','7','8','9','10'})
   ax = gca;
   ax.FontSize = 30; 
   a = colorbar;
   ylabel(a,"p' (Pa)",'FontSize',30,'Rotation',270);
   a.Label.Position(1) = 6;
   %pause(0.3);
   %pause
   
    if imovie==2,
     hh=figure(3);
     %set(hh,'position',[100 50 1400 700]);
     image_counter=image_counter+1;
     fprintf('storing image %i\n',image_counter);
     G=getframe(hh);
     %FF(image_counter)=G;
     [imind,cm] = rgb2ind(frame2im(G),256);
     if image_counter==1, 
       imwrite(imind,cm,['p_',AAA,'.gif'],'gif', 'Loopcount',inf); 
       else 
       imwrite(imind,cm,['p_',AAA,'.gif'],'gif','WriteMode','append'); 
       end;%end if image_counter==1
     %pause(0.5);
     end;%end if imovie==1,
   
   
   
 %maximum = max(max(sum2));
 %[x,y]=find(sum2==maximum);
 regionalMaxima = imregionalmax(sum2);
 [rows, columns] = find(regionalMaxima);
   
  figure(5);
   imagesc(sum2);
   title({'Sum of squares'},'FontSize',40);
   xlabel('x (m)','FontSize',30)
   ylabel('y (m)','FontSize',30)
   
   zoom on
   xlim([0 nx]);
   ylim([0 ny]);
   set(gca,'Ydir','normal');
   hold on
   %h3=plot([IXW(1),IXW(1)],[IYbottom(1),IYtop(1)],'r');
   %set(h3,'LineWidth',3);
   %hold on
   plot((nx/xmax)*sources(:,1),(ny/ymax)*sources(:,2),'ko','MarkerSize', 20)
   hold on
   plot((nx/xmax)*mics(:,1),(ny/ymax)*mics(:,2),'rx','MarkerSize', 20)
   %if ii == nt
    %hold on
    %plot(y,x,'kx','MarkerSize', 30)
   %end
   maxim=zeros(size(rows,1));
   for r=1:size(rows,1)
       maxim(r)=sum2(rows(r),columns(r));
   end
   maxi=zeros(size(mics,1)+1,1);
   for s=1:size(maxi,1)
       maxi(s,1)=max(max(maxim));
       pos_max=find(maxim==maxi(s));
       maxim(pos_max)=0;
       [x,y]=find(sum2==maxi(s));
   %if ii == nt
    hold on
    plot(y,x,'kx','MarkerSize', 30)
   %end
   end
   hold off
   axis equal
   axis on
   %set(cga,'XTickLabel',{0,1,2,3,4,5,6,7,8,9,10});
   xticks([linspace(0,nx,11)])
   xticklabels({'0','1','2','3','4','5','6','7','8','9','10'})
   yticks([linspace(0,nx,11)])
   yticklabels({'0','1','2','3','4','5','6','7','8','9','10'})
   ax = gca;
   ax.FontSize = 30; 
   a = colorbar;
   ylabel(a,"p' (Pa)",'FontSize',30,'Rotation',270);
   a.Label.Position(1) = 6;
   a.Label.Position(2) = 0;
   %pause(0.3);
   %pause
   
    if imovie==2,
     hh1=figure(5);
     %set(hh,'position',[100 50 1400 700]);
     image_counter1=image_counter1+1;
     fprintf('storing image %i\n',image_counter1);
     G=getframe(hh1);
     %FF(image_counter)=G;
     [imind,cm] = rgb2ind(frame2im(G),256);
     if image_counter1==1, 
       imwrite(imind,cm,['sum_',AAA1,'.gif'],'gif', 'Loopcount',inf); 
       else 
       imwrite(imind,cm,['sum_',AAA1,'.gif'],'gif','WriteMode','append'); 
       end;%end if image_counter==1
     %pause(0.5);
     end;%end if imovie==1,
   
   
  end;%end if mod
 end;%end for ii


